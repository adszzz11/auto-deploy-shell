# multi_deploy.sh 명세서

## 개요
여러 인스턴스를 동시에 배포하고 관리하는 메인 오케스트레이션 스크립트입니다. 버전 일관성을 보장하며 실패 시 전체 롤백을 수행합니다.

## 주요 기능

### 다중 인스턴스 배포
- 지정된 수만큼의 인스턴스를 순차적으로 배포 (인스턴스 0부터 시작)
- 각 인스턴스는 `deploy.sh`를 호출하여 개별 배포 수행
- 하나라도 실패하면 전체 롤백 실행

### 스케일링 지원
- **스케일 아웃**: 현재보다 많은 인스턴스 요청 시 추가 배포
- **스케일 인**: 현재보다 적은 인스턴스 요청 시 초과 인스턴스 제거

### 전체 롤백 메커니즘
- 배포 성공한 인스턴스들을 모두 롤백
- 실패한 인스턴스도 롤백 시도
- 버전 일관성 보장

### 현재 상태 분석
- 기존 인스턴스 디렉터리 스캔
- 현재 배포된 인스턴스 수 계산
- 타겟 인스턴스 수와 비교하여 작업 계획 수립

## 사용법
```bash
# 3개 인스턴스로 배포
./multi_deploy.sh 3 production.env

# 5개 인스턴스로 스케일 아웃
./multi_deploy.sh 5 production.env

# 2개 인스턴스로 스케일 인
./multi_deploy.sh 2 production.env
```

## 파라미터
1. `<target_instance_count>`: 목표 인스턴스 수 (2-10)
2. `<env_file>`: 환경 설정 파일 경로

## 배포 시나리오

### 신규 배포
- 인스턴스 0부터 목표 수까지 순차 배포

### 스케일 아웃
- 기존 인스턴스는 업데이트
- 추가 인스턴스는 신규 배포

### 스케일 인
- 목표 수까지는 업데이트
- 초과 인스턴스는 제거

## 에러 처리
1. **즉시 중단**: 하나의 인스턴스라도 배포 실패 시
2. **전체 롤백**: 성공한 모든 인스턴스를 이전 상태로 복원
3. **실패 인스턴스 롤백**: 실패한 인스턴스도 롤백 시도

## 의존성
- common_utils.sh
- deploy.sh
- rollback.sh

## 인스턴스 범위
- 최소: 2개 인스턴스
- 최대: 10개 인스턴스
- 인스턴스 번호: 0부터 시작

## 사용되는 디렉터리 구조
```
SERVICE_BASE_DIR/
└── SERVICE_NAME/
    └── instances/
        ├── 0/
        ├── 1/
        ├── 2/
        └── ...
```

## 로깅
- 각 단계별 상세 로그 출력
- 성공/실패 인스턴스 추적
- 롤백 과정 로깅